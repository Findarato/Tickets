<?php
/**
 * New ticket ajax script
 * @author Joseph Harry
 * @version 2.0
 * @copyright March 28, 2009
 */

	include_once("../header.php");
	$_GET = $db->Clean($_GET);
	$usr = unserialize($_SESSION["user"]);
	if($usr->User_id==$_GET["newTicketUser_id"]){
		if($_GET['newTicketType']=="new"){
			$db->Query('INSERT INTO tickets(created_by_id,assigned_by_id,assigned_id,category_id,subject,description,created_on,open,priority) 
			VALUES(
					"'.$_GET["newTicketUser_id"].'",
					"'.$_GET["newTicketUser_id"].'",
					"'.$_GET["newTicketAssign"].'",
					"'.$_GET["newTicketCategory"].'",
					"'.$_GET["newTicketTitle"].'",				
					"'.nl2br($_GET["newTicketDescription"]).'",
					NOW(),1,
					"'.(intval($_GET["newTicketPriority"])+1).'"
						)');
				$ticketId = $db->Lastid;
				
				$db->Query("SELECT assigned_by_id,created_on,assigned_id,created_by_id,id,subject,description,priority,category FROM tcview WHERE id=".$ticketId);
				$res1 = $db->Fetch("assoc");
				$users = getUsers();
				$userName = ucwords($users[$res1['created_by_id']]['firstname'])." ".ucwords($users[$res1['created_by_id']]['lastname']);
				$body = $res1['description'];
				$smarty -> assign('email_ticket_id',$ticketId);
				$smarty -> assign('email_created_on',$res1['created_on']);
				$smarty -> assign('email_created_by',$userName);
				$smarty -> assign('email_category',$res1['category']);
				$smarty -> assign('email_title',$res1['subject']);
				$smarty -> assign('email_priority',$res1['priority']);				
				$smarty -> assign('email_description',nl2br($res1['description']));
				$smarty -> assign('showRes',"0");
				if(isset($respon)){	$smarty -> assign('respon',$respon);}
				$body = $smarty->fetch('email.tpl');
				generateEmail($res1['created_by_id'],$res1['assigned_id'],$res1['id'],$body,false);				
		}else{
			$db->Query('UPDATE tickets SET
					assigned_id="'.$_GET["newTicketAssign"].'",
					category_id="'.$_GET["newTicketCategory"].'",
					subject="'.$_GET["newTicketTitle"].'",				
					description="'.nl2br($_GET["newTicketDescription"]).'",
					modified_on=NOW(),
					priority="'.(intval($_GET["newTicketPriority"])+1).'"
					WHERE id='.$_GET['newTicketTicket_id'].'
					');
			addReply($_GET['newTicketTicket_id'],256,"Ticket Edited","This ticket was Edited on ".date("D M j, Y G:i:s ")." by <span class=\"gold\">".$usr->A_U['first-name']." ".$usr->A_U['last-name']."</span>");
		}

	}

?> 