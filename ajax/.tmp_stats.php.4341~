<?Php
/**
 * Statistics for Tickets.
 * There will be a few paramaters this page will take, then return a json result of the statistics.
 * @author Joseph Harry  
 * @version 1.0  
 * @copyright May 27, 2009
 */
include_once "../small_header.php";
$usr = unserialize($_SESSION['user']);
$response = array("message"=>"","error"=>"");
if(isset($_GET['type'])){/*This is a valid get request*/
	$_GET = $db->Clean($_GET); //lets clean up the get array
//	print_r($_GET);
	$sql = "";//create the sql variable that will eventurally get ran at the end
	if(isset($_GET['type'])){
		foreach (explode(',',$_GET['type']) as $t){
			$searchTitle = "";
			switch ($t){
				case 1:
					$sql = "SELECT COUNT(id) AS cntId,AVG(priority) AS avgPriority FROM tcview AS t WHERE YEAR(created_on)=".date("Y").";";
					$searchTitle = "general";
				break;
				case 2:
					$sql = "SELECT COUNT(id) AS cntId,AVG(priority) AS avgPriority FROM tcview AS t WHERE YEAR(created_on)=".date("Y")." AND open=1;";
					$searchTitle = "open";
				break;			
				case 3:
					$sql = "SELECT AVG(TIMESTAMPDIFF(SECOND ,t.created_on, t.closed_on )) AS dago FROM tcview AS t WHERE YEAR(created_on)=".date("Y")." AND open=0;";
					$searchTitle = "closed";
				break;	
				case 4:
					$sql = "SELECT AVG(TIMESTAMPDIFF(SECOND ,t.created_on, t.closed_on )) AS dago FROM tcview AS t WHERE YEAR(created_on)=".date("Y")." AND open=0 AND assigned_id=".$usr->User_id.";";
					$searchTitle = "myclosed"; 
				break;	
				case 5:
					$sql = "SELECT COUNT(id) as cntId FROM responses AS t WHERE YEAR(created_on)=".date("Y").";";
					$searchTitle = "totalResponses"; 
				break;
				default:break;
			}
			$response['message'] = "Generating General Statistics";
			$db->Query($sql);
			$res = $db->Fetch("assoc");	
			if(count($db->Error)==2){$response['error']=$db->Error[1];}	
			$response['stats'][$searchTitle] = $res;
		}
	}
//	echo array2json($response);
	echo json_encode($response);
}else{
	$response['message'] = "No statistics asked for";
	$response['error'] = "No statistics asked for";
	echo json_encode($response);
}
?>