<?Php
/**
 * Ticket display script.  Very simple just returns the ticket info, and responses if needed
 * @author Joseph Harry
 * @version 1.0
 * @copyright March 16, 2009
 */
include_once("../small_header.php");
header('Content-type: application/json');
$usr = unserialize($_SESSION['user']);
$_GET = $db->Clean($_GET);
if(isset($_GET['ticket_id'])){
	/*This is a valid ticket request*/
	$res = $db->Query("SELECT tcv.*, 
	TIMESTAMPDIFF(SECOND ,tcv.created_on, now( ) ) AS dago,
	TIMESTAMPDIFF(SECOND ,tcv.closed_on, now( ) ) AS dagoc,
	DATE_FORMAT(tcv.created_on	, '%M %e, %Y %H:%i') AS created_on,
	DATE_FORMAT(tcv.closed_on	, '%M %e, %Y %H:%i') AS closed_on,
	DATE_FORMAT(tcv.due_on	, '%M %e, %Y %H:%i') AS due_on,
	TIMESTAMPDIFF(SECOND ,tcv.due_on, now( ) ) AS timeRemaining,
	f.ticket_id AS favorite,
	lhu.username,
	lhu.firstname,
	lhu.lastname, 
	lhu2.username as username2,
	lhu2.firstname AS firstname2,
	lhu2.lastname AS lastname2,
	tcv.assigned_by_id,
	tcv.status,
	tcv.subject,
	tcv.attachment
	FROM tcview AS tcv 
	LEFT JOIN favorite AS f ON (tcv.id=f.ticket_id AND f.user_id=".$usr->User_id.") 
	JOIN lapcat.hex_users AS lhu ON (tcv.assigned_id=lhu.id)
	JOIN lapcat.hex_users AS lhu2 ON (tcv.created_by_id=lhu2.id)
	WHERE tcv.id=".$_GET['ticket_id']); 
	$return = $db->Fetch("assoc");
	if(count($db->Error)==2){$return['error']==$db->Error;}
	if(@unserialize($return['status'])){
		$return['status'] = unserialize($return['status']);}
	$return['dbDescription']=$return['description'];
	$return['description']=Tcode($return['description']);
	if(@unserialize($return['attachment'])){
		$return['attachment'] = unserialize($return['attachment']);}		
/**
 * Insert the newest ticket, then get the recent tickets
 */
	//lets remove the old entry before adding the new
	$db->Query("DELETE FROM recent_tickets WHERE user_id=".$usr->User_id." AND ticket_id=".$_GET['ticket_id']." AND ticket_name='".$return['subject']."' LIMIT 1");
	$db->Query("INSERT INTO recent_tickets (user_id,ticket_id,ticket_name,dt) VALUES (".$usr->User_id.",".$_GET['ticket_id'].",'".$return['subject']."',NOW());");
	$return['error']=$db->Error;
	$db->QUERY("SELECT ticket_id,ticket_name FROM recent_tickets WHERE user_id=".$usr->User_id." ORDER BY dt DESC LIMIT 10;");
	$res1 = $db->Fetch("assoc_array");
	$return['recentTickets'] = $res1;
	
	echo json_encode($return);
}
?>  